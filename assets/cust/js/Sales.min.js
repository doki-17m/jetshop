function autoComplete(){classBarcode.autocomplete({source:CUST_URL+PRODUCT+"/showProduct/?",minLength:1,scroll:!0,select:function(e,o){$(this).val(o.item.value);var t=$(this).val();""!==t&&(setQty=1,insertCart(t,setQty))},close:function(){$(this).val(""),autoFocus()}}).keyup(function(e){13===e.keyCode&&(e.preventDefault(),$(this).val(""))}).data("ui-autocomplete")._renderItem=function(e,o){return $("<li class='ui-autocomplete-row'></li>").data("item.autocomplete",o).append(o.label).appendTo(e)}}function showTable(e){_tablePOS.ajax.url(e).load().draw(!0),_tablePOS.on("xhr",function(e){var o=_tablePOS.ajax.json(),t=o.total;arrCart.push(o),t>0?(totalAmount=t,msgGrandTotal.html(formatRupiah(totalAmount))):(totalAmount=0,msgGrandTotal.html(formatRupiah(totalAmount)))})}function insertCart(e,o){url=SITE_URL+"/create_cart?code="+e+"&qty="+o,showTable(url)}function updateCart(e,o){url=SITE_URL+"/edit_cart?id="+e+"&qty="+o,showTable(url)}function destroyCart(e){setQty=0,url=SITE_URL+"/edit_cart?id="+e+"&qty="+setQty,showTable(url)}function clearTable(){url=SITE_URL+"/destroy_allcart?",showTable(url)}function indecrementVal(e,o,t,r){var l=$(o.target).closest(".input-group"),s=parseInt(l.find("input[name="+t+"]").val(),10);isNaN(s)||r!==ACTION_increment?isNaN(s)||r!==ACTION_decrement?l.find("input[name="+t+"]").val(0):(setQty=s-1,l.find("input[name="+t+"]").val(setQty)):(setQty=s+1,l.find("input[name="+t+"]").val(setQty)),updateCart(e,setQty)}function saveOrder(e){var o=fillSDate.val(),t=fillSCashier.val(),r=MemberValue(),l=$("#pos_courier option:selected").val(),s=$("#pos_payment option:selected").val(),i=$("#pos_bankacc option:selected").val(),a=$("#form_checkout").serialize()+"&pos_courier="+l+"&ismember="+r+"&pos_date="+o+"&pos_cashier="+t+"&pos_payment="+s+"&pos_bankacc="+i+"&isurgent="+UrgentValue(),n=callbackTable(e);$.ajax({url:SITE_URL+"/checkQty",type:"POST",data:{data:n},cache:!1,dataType:"JSON",beforeSend:function(){$("#btn_pos").attr("disabled",!0),loadingForm("form_checkout","facebook")},success:function(e){e.length>0?($.each(e,function(e,o){var t=o.zero,r=o.more;t&&Toast.fire({type:"error",title:t}),r&&Toast.fire({type:"error",title:r})}),$("#btn_pos").removeAttr("disabled"),hideLoadingForm("form_checkout")):(url=SITE_URL+CREATE,$.ajax({url:url,type:"POST",data:a,cache:!1,dataType:"JSON",success:function(e){e.error&&(""!=e.error_pos_cust_id?errPosCustSelect.html(e.error_pos_cust_id):errPosCustSelect.html(""),""!=e.error_pos_cust_name?(errPosCustInput.html(e.error_pos_cust_name),fillPosCustInput.addClass(isInvalid)):(errPosCustInput.html(""),fillPosCustInput.removeClass(isInvalid)),""!=e.error_pos_phone?(errPosPhone.html(e.error_pos_phone),fillPosPhone.addClass(isInvalid)):(errPosPhone.html(""),fillPosPhone.removeClass(isInvalid)),""!=e.error_pos_courier?errPosCourier.html(e.error_pos_courier):errPosCourier.html(""),""!=e.error_pos_city?errPosCity.html(e.error_pos_city):errPosCity.html(""),""!=e.error_pos_faddress?(errPosAddress.html(e.error_pos_faddress),fillPosAddress.addClass(isInvalid)):(errPosAddress.html(""),fillPosAddress.removeClass(isInvalid)),""!=e.error_pos_delivery?errPosDelivery.html(e.error_pos_delivery):errPosDelivery.html(""),""!=e.error_pos_payment?errPosPayment.html(e.error_pos_payment):errPosPayment.html(""),""!=e.error_pos_bankacc?errPosBank.html(e.error_pos_bankacc):errPosBank.html(""),$("#btn_pos").removeAttr("disabled"),hideLoadingForm("form_checkout")),e.last_id&&saveOrderLine(n,e.last_id)}}))}})}function saveOrderLine(e,o){url=SITE_URL+"/create_line",$.ajax({url:url,type:"POST",data:{id:o,data:e},dataType:"JSON",success:function(e){e.success&&(Toast.fire({type:"success",title:e.message}),getInvoiceNo(o),clearErrPos(),chkdPos(),clearTable(),$("#btn_pos").removeAttr("disabled"),hideLoadingForm("form_checkout"),btnPos.hide(),btnPrint.show(),btnClosePos.show())}})}function MemberValue(){var e;return e=cxbIsmember.is(":checked")?active:nonactive,e}function UrgentValue(){var e;return e=$("#pos_isurgent").is(":checked")?active:nonactive,e}function checkoutData(){var e=arrCart[arrCart.length-1];$("#modal_checkout").modal({backdrop:"static",keyboard:!1}),Scrollmodal(),modalDialog.addClass("modal-xl"),modalTitle.html("New Order"),$("#form_checkout")[0].reset(),btnClosePos.hide(),btnPrint.hide(),fillPosPhone.prop("readonly",!0),fillPosCourier.prop("disabled",!0),fillPosDelivery.prop("disabled",!0),groupPosCustInput.hide(),groupPosCustDelivery.hide(),groupPosCustCity.hide(),groupPosCustAddress.hide(),groupPosCustJMarket.hide(),groupPosBank.hide(),fillPosPayment.val(null).change(),fillPosBank.val(null).change(),posCustomer(null,null),posCourier(null,null),posCity(null,null),getTotalWeight(e),getListCart(table,e),posAccount(null,null),cxbIsmember.change(function(e){var o=!0;cxbIsmember.is(":checked")||(o=!1),o?(groupPosCustSelect.show(),groupPosCustInput.hide(),groupPosCustCity.hide(),groupPosCustAddress.hide(),groupPosCustDelivery.hide(),fillPosPhone.val(""),fillPosPhone.prop("readonly",!0)):(groupPosCustSelect.hide(),fillPosCustSelect.val(null).change(),groupPosCustInput.show(),$("#pos_isurgent").is(":checked")?(groupPosCustCity.hide(),groupPosCustAddress.hide()):(groupPosCustAddress.show(),groupPosCustCity.show()),fillPosPhone.val(""),fillPosPhone.removeAttr("readonly"),fillPosAddress.val(""))})}function getListCart(e,o){const t=$("#list_cart");var r="",l=o.data,s=o.total,i=0,a=0;r+='<tr id="list_header"><th>Product </th><th>Qty </th><th>Amount </th></tr>',$.each(l,function(e,o){var t=o[0],l=o[1],s=o[3],i=replaceRupiah(o[6]);r+='<tr id="product_group"><th class="product" id="'+t+'" style="text-align: left; width: 200px">'+s+'</th><td class="qty" id="'+l+'">x'+l+'</td><td class="amount" style="text-align: right"><input type="text" class="form-control rupiah" style="text-align: right;" value="'+i+'"></tr>'}),r+='<tr id="subtotal"><th colspan="2" style="text-align: right">Subtotal: </th><td class="subtotal" style="text-align: right">'+formatRupiah(s)+"</td></tr>",r+='<tr id="ongkir"><th colspan="2" style="text-align: right">Shipping: </th><td class="ongkir" style="text-align: right">'+i+"</td></tr>",r+='<tr id="grandTotal"><th colspan="2" style="text-align: right">Grand Total: </th><td class="grandTotal" style="text-align: right; color: red">'+a+"</td></tr>",t.html(r);var n=$(".subtotal"),u=$(".ongkir"),p=$(".grandTotal");$("#pos_isurgent").is(":checked")&&(s=replaceRupiah(n.html()),i=replaceRupiah(u.html()),a=parseInt(s)+parseInt(i),p.html(formatRupiah(a))),$("#pos_isurgent").change(function(e){$("#pos_isurgent").is(":checked")&&(s=replaceRupiah(n.html()),i=u.html(0),a=parseInt(s)+parseInt(0),p.html(formatRupiah(a)))}),fillPosDelivery.change(function(e){i=$(this).val().substring($(this).val().search("/")+1),s=replaceRupiah(n.html()),a=parseInt(s)+parseInt(i),u.html(formatRupiah(i)),p.html(formatRupiah(a))}),$(".rupiah").autoNumeric("init",{aSep:".",aDec:",",mDec:"0"}).on("keypress keyup blur",function(o){var t=[];for(let o in e.rows){let l=e.rows[o].id,s=e.rows[o];if("product_group"===l)for(let e in s.cells){let o=s.cells[e],l=s.cells[e].className;if("amount"===l){var r=replaceRupiah(o.lastChild.value);t.push(r)}}}var l=t.toString().split(",").map(Number);i=replaceRupiah(u.html()),s=replaceRupiah(n.html()),a=parseInt(s)+parseInt(i);var c=l.reduce(function(e,o){return e+o});n.html(formatRupiah(c)),u.html(formatRupiah(i)),p.html(formatRupiah(a))})}function callbackTable(e){var o=[],t=[],r=[],l=[],s=[];for(let u in e.rows){let p=e.rows[u];for(let e in p.cells){let u=p.cells[e],c=p.cells[e].className;if("product"===c&&o.push({product_id:u.id}),"qty"===c&&t.push({qty:u.id}),"amount"===c){var i=parseInt(replaceRupiah(u.lastChild.value));r.push({amount:i})}if("ongkir"===c){var a=parseInt(replaceRupiah(u.innerHTML));l.push({ongkir:a})}if("grandTotal"===c){var n=parseInt(replaceRupiah(u.innerHTML));s.push({grandtotal:n})}}}return o.map((e,o)=>Object.assign({},e,t[o],r[o],l[o],s[o]))}function getInvoiceNo(e){url=SITE_URL+"/getDocNo?id="+e,$.getJSON(url,function(e){modalTitle.html("BIll No: "+e)})}function getTotalWeight(e){url=SITE_URL+"/totalWeight",$.ajax({url:url,type:"POST",data:e,dataType:"JSON",success:function(e){fillPosWeight.val(e)}})}function posCashier(){url=CUST_URL+USER+"/showCashier",$.getJSON(url,function(e){var o=e.m_job_id,t=e.sys_user_id,r=e.username;1==o?fillSCashier.append('<option value="'+t+'" selected="selected">'+r+"</option>"):fillSCashier.append('<option value="" selected="selected"></option>'),fillSCashier.prop("disabled",!0)})}function posCustomer(e,o){url=CUST_URL+CUSTOMER+"/showCustomer",$.getJSON(url,function(e){fillPosCustSelect.empty(),fillPosCustSelect.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,t){var r=t.m_bpartner_id,l=t.value,s=l+"_"+t.name;o==r?fillPosCustSelect.append('<option value="'+r+'" selected="selected">'+s+"</option>"):fillPosCustSelect.append('<option value="'+r+'">'+s+"</option>")})})}function posCourier(e,o){url=CUST_URL+COURIER+"/showCourier",$.getJSON(url,function(e){fillPosCourier.empty(),fillPosCourier.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,t){var r=t.m_courier_id,l=t.value,s=t.name;o==r?fillPosCourier.append('<option value="'+l+'" selected="selected">'+s+"</option>"):fillPosCourier.append('<option value="'+l+'">'+s+"</option>")})})}function posCity(e,o){url=CUST_URL+CITY+"/showCity",$.ajax({url:url,type:"POST",data:{id:null},dataType:"JSON",success:function(e){fillPosCity.empty(),fillPosCity.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,t){var r=t.m_city_id,l=t.type,s=l+" "+t.name;o==r?fillPosCity.append('<option value="'+r+'" selected="selected">'+s+"</option>"):fillPosCity.append('<option value="'+r+'">'+s+"</option>")})}})}function getDelivery(e,o){var t=0,r=0,l=null;fillPosCourier.change(function(e){url=SITE_URL+"/cost",t=$("#pos_city option:selected").val(),r=fillPosWeight.val(),l=$(this).val(),fillPosDelivery.prop("disabled",!0),fillPosDelivery.empty(),$.ajax({url:url,type:"POST",data:{origin:delivery,destination:t,weight:r,courier:l},dataType:"JSON",success:function(e){400===e.code?Toast.fire({type:"error",title:e.description}):(fillPosDelivery.prop("disabled",!1),fillPosDelivery.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,o){var t=o.cost,r=(o.description,o.service);$.each(t,function(e,o){var t=o.etd,l=o.value,s=r+" - (Rp. "+formatRupiah(l)+", Estimasi pengiriman : "+t+" Hari)";fillPosDelivery.append('<option value="'+r+"/"+l+'">'+s+"</option>")})}))},error:function(e,o,t){console.info(t),alert(t)}})}),fillPosCity.change(function(e){url=SITE_URL+"/cost",t=$(this).val(),r=fillPosWeight.val(),l=$("#pos_courier option:selected").val(),fillPosDelivery.prop("disabled",!0),fillPosDelivery.empty(),$.ajax({url:url,type:"POST",data:{origin:delivery,destination:t,weight:r,courier:l},dataType:"JSON",success:function(e){400===e.code?Toast.fire({type:"error",title:e.description}):(fillPosDelivery.prop("disabled",!1),fillPosDelivery.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,o){var t=o.cost,r=(o.description,o.service);$.each(t,function(e,o){var t=o.etd,l=o.value,s=r+" - (Rp. "+formatRupiah(l)+", Estimasi pengiriman : "+t+" Hari)";fillPosDelivery.append('<option value="'+r+"/"+l+'">'+s+"</option>")})}))},error:function(e,o,t){console.info(t),alert(t)}})})}function posAccount(e,o){url=CUST_URL+ACCOUNT+"/showAccount",$.getJSON(url,function(e){fillPosBank.empty(),fillPosBank.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,t){var r=t.m_account_id,l=t.bank,s=t.accountno,i=s+"_"+l+" - "+t.name;o==r?fillPosBank.append('<option value="'+r+'" selected="selected">'+i+"</option>"):fillPosBank.append('<option value="'+r+'">'+i+"</option>")})})}function autoFocus(){document.getElementById("pos_barcode").focus()}function clearFilPos(){fillSBarcode.val("")}function clearErrPos(){errPosCustSelect.html(""),errPosCustInput.html(""),errPosPhone.html(""),errPosCourier.html(""),errPosCity.html(""),errPosAddress.html(""),errPosDelivery.html(""),fillPosPhone.removeClass(isInvalid),fillPosAddress.removeClass(isInvalid),errPosPayment.html(""),errPosBank.html("")}function chkdPos(){fillPosCustInput.prop("readonly",!0),fillPosPhone.prop("readonly",!0),fillPosAddress.prop("readonly",!0),fillPosJMarket.prop("readonly",!0),fillPosNote.prop("readonly",!0),fillPosWeight.prop("readonly",!0),fillPosCustSelect.prop("disabled",!0),fillPosCourier.prop("disabled",!0),fillPosCity.prop("disabled",!0),fillPosDelivery.prop("disabled",!0),cxbIsmember.prop("disabled",!0),fillPosPayment.prop("disabled",!0),fillPosBank.prop("disabled",!0)}function unchkdPos(){fillPosCustInput.prop("readonly",!1),fillPosPhone.prop("readonly",!1),fillPosAddress.prop("readonly",!1),fillPosJMarket.prop("readonly",!1),fillPosNote.prop("readonly",!1),fillPosCustSelect.prop("disabled",!1),fillPosCourier.prop("disabled",!1),fillPosCity.prop("disabled",!1),fillPosDelivery.prop("disabled",!1),cxbIsmember.prop("disabled",!1),fillPosPayment.prop("disabled",!1),fillPosBank.prop("disabled",!1)}function loadingForm(e,o){$("#"+e).waitMe({effect:o,text:"Please wait...",bg:"rgba(255,255,255,0.7)",color:"#000",maxSize:"",waitTime:-1,textPos:"vertical",fontSize:"100%",source:"",onClose:function(){}})}function hideLoadingForm(e){$("#"+e).waitMe("hide")}const fillSDate=$("[name = pos_date]"),fillSCashier=$("[name = pos_cashier]"),fillSBarcode=$("[name = pos_barcode]"),msgGrandTotal=$("#grandtotal"),btnCheckout=$("#btn_checkout"),btnPrint=$("#btn_print"),btnPos=$("#btn_pos"),btnClosePos=$("#btn_close_pos"),btnRefresh=$("#btn_refresh"),showDataTable=$("#show_data"),boxCustomer=$("#detail_datacustomer"),boxCart=$("#detail_cart"),fillPosCustSelect=$("[name = pos_cust_id]"),fillPosCustInput=$("[name = pos_cust_name]"),fillPosPhone=$("[name = pos_phone]"),fillPosCourier=$("[name = pos_courier]"),fillPosWeight=$("[name = pos_total_weight]"),fillPosDelivery=$("[name = pos_delivery]"),fillPosCity=$("[name = pos_city]"),fillPosAddress=$("[name = pos_address]"),fillPosJMarket=$("[name = pos_job_market]"),fillPosNote=$("[name = pos_note]"),fillPosPayment=$("[name = pos_payment]"),fillPosBank=$("[name = pos_bankacc]"),groupPosCustSelect=$("#group_pos_cust_id"),groupPosCustInput=$("#group_pos_cust_name"),groupPosPhone=$("#group_pos_phone"),groupPosCourier=$("#group_pos_courier"),groupPosCustDelivery=$("#group_pos_delivery"),groupPosCustCity=$("#group_pos_city"),groupPosCustAddress=$("#group_pos_address"),groupPosCustJMarket=$("#group_pos_job_market"),groupPosBank=$("#group_pos_bankacc"),errPosCustSelect=$("#error_pos_cust_id"),errPosCustInput=$("#error_pos_cust_name"),errPosPhone=$("#error_pos_phone"),errPosCourier=$("#error_pos_courier"),errPosCity=$("#error_pos_city"),errPosAddress=$("#error_pos_faddress"),errPosDelivery=$("#error_pos_delivery"),errPosPayment=$("#error_pos_payment"),errPosBank=$("#error_pos_bankacc"),cxbIsmember=$("#pos_ismember"),ACTION_increment="INCREMENT",ACTION_decrement="DECREMENT",table=document.getElementById("list_cart");let totalAmount=0,setQty=0;var arrCart=[];$(document).ready(function(){msgGrandTotal.html(formatRupiah(totalAmount)),clearFilPos(),posCashier(),_tablePOS.on("change paste",".quantity-field",function(e){ID=$(this).prop("id");var o=$(this).val();updateCart(ID,o)}),_tablePOS.on("keypress",".quantity-field",function(e){$(this).val($(this).val().replace(/[^\d].+/,"")),(e.which<48||e.which>57)&&e.preventDefault(),"Enter"===e.code&&autoFocus()}),_tablePOS.on("click",".button-plus, .button-minus",function(e){ID=$(this).val();var o=$(this).prop("id"),t=$(this).data("button");indecrementVal(ID,e,t,"button-plus"===o?ACTION_increment:ACTION_decrement),autoFocus()}),btnRefresh.click(function(){clearFilPos(),autoFocus(),clearTable()}),btnCheckout.click(function(e){e.preventDefault();const o=_tablePOS.data().any();o&&(checkoutData(),btnPos.show(),groupPosCustSelect.show(),$("#group_pos_total_weight").hide())}),"sales"==LAST_URL&&autoComplete()}),fillSBarcode.scannerDetection({timeBeforeScanTest:100,avgTimeByChar:40,preventDefault:!0,endChar:[13],onComplete:function(e,o){validScan=!0,fillSBarcode.val(e),insertCart(e,o)},onError:function(e,o){fillSBarcode.val(fillSBarcode.val()+e)}}),fillPosCustSelect.change(function(e){var o=$(this).val();fillPosCourier.prop("disabled",!1),url=CUST_URL+CUSTOMER+SHOW+o,$.getJSON(url,function(e){var o=e.phone,t=e.address,r=e.city_id;posCity(null,r),fillPosPhone.val(o),fillPosAddress.val(t)})}),btnPos.click(function(e){saveOrder(table)}),fillPosDelivery.change(function(e){groupPosCustJMarket.show()}),fillPosPayment.change(function(e){var o=$(this).val();2==o?(groupPosBank.show(),fillPosBank.val(null).change()):(groupPosBank.hide(),fillPosBank.val(null).change())});var delivery=155;fillPosCourier.change(function(e){url=SITE_URL+"/cost";let o=$("#pos_city option:selected").val(),t=fillPosWeight.val(),r=$(this).val();if(fillPosDelivery.prop("disabled",!0),fillPosDelivery.empty(),!$("#pos_isurgent").is(":checked")&("pos"===r|"tiki"===r|"jne"===r))return $.ajax({url:url,type:"POST",data:{origin:delivery,destination:o,weight:t,courier:r},cache:!1,dataType:"JSON",beforeSend:function(){$("#btn_pos").attr("disabled",!0),loadingForm("form_checkout","facebook")},complete:function(){$("#btn_pos").removeAttr("disabled"),hideLoadingForm("form_checkout"),fillPosDelivery.removeAttr("disabled"),groupPosCustDelivery.show(),groupPosCustCity.show(),groupPosCustAddress.show()},success:function(e){400===e.code?(Toast.fire({type:"error",title:e.description}),fillPosDelivery.prop("disabled",!0)):(fillPosDelivery.prop("disabled",!1),fillPosDelivery.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,o){var t=o.cost,r=(o.description,o.service);$.each(t,function(e,o){var t=o.etd,l=o.value,s=r+" - (Rp. "+formatRupiah(l)+", Estimasi pengiriman : "+t+" Hari)";fillPosDelivery.append('<option value="'+r+"/"+l+'">'+s+"</option>")})}))},error:function(e,o,t){console.info(t),alert(t)}}),!1}),fillPosCity.change(function(e){url=SITE_URL+"/cost";let o=$(this).val(),t=fillPosWeight.val(),r=$("#pos_courier option:selected").val();fillPosDelivery.prop("disabled",!0),fillPosDelivery.empty(),$.ajax({url:url,type:"POST",data:{origin:delivery,destination:o,weight:t,courier:r},cache:!1,dataType:"JSON",beforeSend:function(){$("#btn_pos").attr("disabled",!0),loadingForm("form_checkout","facebook")},complete:function(){$("#btn_pos").removeAttr("disabled"),hideLoadingForm("form_checkout"),fillPosDelivery.removeAttr("disabled")},success:function(e){400===e.code?(Toast.fire({type:"error",title:e.description}),fillPosDelivery.attr("disabled",!0)):(fillPosDelivery.prop("disabled",!1),fillPosDelivery.append('<option selected="selected" value="">-- Choose One --</option>'),$.each(e,function(e,o){var t=o.cost,r=(o.description,o.service);$.each(t,function(e,o){var t=o.etd,l=o.value,s=r+" - (Rp. "+formatRupiah(l)+", Estimasi pengiriman : "+t+" Hari)";fillPosDelivery.append('<option value="'+r+"/"+l+'">'+s+"</option>")})}))},error:function(e,o,t){console.info(t),alert(t)}})}),$(document).on("click","#close_checkout, #btn_close_pos",function(e){$("#modal_checkout").modal("hide"),$("#form_checkout")[0].reset(),clearErrPos(),unchkdPos(),$("#form_checkout")[0].reset()}),$("#pos_isurgent").change(function(e){$(this).is(":checked")?($("#group_pos_total_weight").hide(),groupPosCustDelivery.hide(),groupPosCustCity.hide(),groupPosCustAddress.hide(),groupPosCustJMarket.hide()):($("#group_pos_total_weight").show(),groupPosCustDelivery.show(),groupPosCustCity.show(),groupPosCustAddress.show())});